# AFlame
Generate flamegraphs from Android method trace files

Server for parsing `.trace` files generated by the Android
[Debug#{start,stop}MethodTracing](https://developer.android.com/reference/android/os/Debug.html#startMethodTracing(java.lang.String, int, int))
method.

This project relies on Brendan Gregg's excellent [Flamegraph](https://github.com/brendangregg/FlameGraph)
project to generate the graphs themselves.

A copy of this server is hosted at https://aflame.rhye.org/

An example trace file from the `onCreate` of a simple recipe app can be seen [here](https://aflame.rhye.org/trace/612054F4E2322B45066E3A882ABD51FB)

## Android Trace file format
There doesn't seem to be much documentation around the Android .trace files, but from what I can tell they are organized as such:

### *version section
Plain text section of key=value pairs. Includes general info about the trace.

- data-file-overflow: ???
- clock: dual, if the trace contains both system and wall clock time
- elapsed-time-usec: total time elapsed during the trace
- num-method-calls: total number of calls contained in the trace
- clock-call-overhead-nsec: The time it takes to actually check the clock.
- vm: Art or Dalvik
- pid: PID of the process under trace

### *threads section
Plain text section of tab separated pairs.
Each pair is a base 10 thread ID, and a thread name.
This numeric thread ID is referenced from the trace data section.

### *methods section
Plain text section of tab separated pairs.
Each line is a 5-tuple of:
- Method ID (in hex). A primary key for referring to a method entry.
- Class name
- Method name
- Type signature
- Source file

The method ID is referenced from the trace data section.
Note that all of the method IDs listed here are even numbers - this is because the binary trace data section uses
(MethodId + 1) to indicate the return from MethodId.

### Raw trace data section
All numbers are stored as little-endian.

Header:
- Magic (4 bytes): 'SLOW'
- Version (2 bytes): Most traces seem to be version 3.
- Data Offset (2 bytes): The number of bytes after the header that the data section begins.
- Start Time (8 bytes): The time (microseconds) that the trace began
- Recordsize (2 bytes): The number of bytes in each trace record.

Data records (v3):
- ThreadId (2 bytes): References the threads table above
- MethodId (4 bytes): References the methods table above
- TimeDelta (4 bytes): Offset into the trace at which this record was logged (microsecs)
- Wall clock delta (4 bytes) Offset into the trace (wall time) at which this record was logged

Each method record denotes the entry into (if the MethodId is even) or exit from (if the MethodId is odd) a function call.
By pushing and popping the records onto a virtual stack per thread, you can recreate the trace, and use the offsets to work
out how much time was spent in each function.

All parsing code can be seen [here](https://github.com/rschlaikjer/erlang-atrace-flamegraphs/blob/master/src/aflame_trace_parser.erl#L259).
